version: '3.8'

services:
  # =========================================
  # Databases (Database per Service Pattern)
  # =========================================
  
  # PostgreSQL for Matching Service
  matching-db:
    image: postgres:15-alpine
    container_name: matching-db
    environment:
      POSTGRES_DB: matching_db
      POSTGRES_USER: matching_user
      POSTGRES_PASSWORD: matching_pass
    ports:
      - "5432:5432"
    volumes:
      - matching-db-data:/var/lib/postgresql/data
      - ./matching-service/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - ride-hailing-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U matching_user -d matching_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # MongoDB for Pricing Service
  pricing-db:
    image: mongo:7
    container_name: pricing-db
    environment:
      MONGO_INITDB_ROOT_USERNAME: pricing_user
      MONGO_INITDB_ROOT_PASSWORD: pricing_pass
      MONGO_INITDB_DATABASE: pricing_db
    ports:
      - "27017:27017"
    volumes:
      - pricing-db-data:/data/db
      - ./pricing-service/init.js:/docker-entrypoint-initdb.d/init.js
    networks:
      - ride-hailing-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 5

  # PostgreSQL for Payment Service
  payment-db:
    image: postgres:15-alpine
    container_name: payment-db
    environment:
      POSTGRES_DB: payment_db
      POSTGRES_USER: payment_user
      POSTGRES_PASSWORD: payment_pass
    ports:
      - "5433:5432"
    volumes:
      - payment-db-data:/var/lib/postgresql/data
      - ./payment-service/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - ride-hailing-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U payment_user -d payment_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # =========================================
  # Infrastructure
  # =========================================
  
  # Zookeeper (required for Kafka)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - ride-hailing-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - ride-hailing-network
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 10s
      timeout: 10s
      retries: 10

  # Redis (for Pricing cache)
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - ride-hailing-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # =========================================
  # Backend Services
  # =========================================

  # API Gateway (Node.js/Express)
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - MATCHING_SERVICE_URL=http://matching-service:3001
    depends_on:
      - matching-service
    networks:
      - ride-hailing-network
    restart: unless-stopped

  # Matching Service (Node.js + PostgreSQL + gRPC + Kafka)
  matching-service:
    build:
      context: ./matching-service
      dockerfile: Dockerfile
    container_name: matching-service
    ports:
      - "3001:3001"
    environment:
      - PORT=3001
      - DATABASE_URL=postgres://matching_user:matching_pass@matching-db:5432/matching_db
      - PROTO_PATH=/app/proto/pricing.proto
      - PRICING_SERVICE_HOST=pricing-service:50051
      - PRICING_HTTP_URL=http://pricing-service:3002
      - PAYMENT_SERVICE_URL=http://payment-service:3003
      - KAFKA_BROKER=kafka:9092
    volumes:
      - ./proto:/app/proto:ro
    depends_on:
      matching-db:
        condition: service_healthy
      kafka:
        condition: service_healthy
      pricing-service:
        condition: service_started
      payment-service:
        condition: service_started
    networks:
      - ride-hailing-network
    restart: unless-stopped

  # Pricing Service (Go/Gin + MongoDB + gRPC + Redis)
  pricing-service:
    build:
      context: ./pricing-service
      dockerfile: Dockerfile
    container_name: pricing-service
    ports:
      - "3002:3002"
      - "50051:50051"
    environment:
      - HTTP_PORT=3002
      - GRPC_PORT=50051
      - MONGO_URL=mongodb://pricing_user:pricing_pass@pricing-db:27017/pricing_db?authSource=admin
      - REDIS_URL=redis:6379
    depends_on:
      pricing-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ride-hailing-network
    restart: unless-stopped

  # Payment Service (Python/FastAPI + PostgreSQL + Kafka)
  payment-service:
    build:
      context: ./payment-service
      dockerfile: Dockerfile
    container_name: payment-service
    ports:
      - "3003:3003"
    environment:
      - PORT=3003
      - DATABASE_URL=postgresql://payment_user:payment_pass@payment-db:5432/payment_db
      - KAFKA_BROKER=kafka:9092
    depends_on:
      payment-db:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - ride-hailing-network
    restart: unless-stopped

  # =========================================
  # Frontend
  # =========================================

  # Frontend (React + Vite)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:3000
    depends_on:
      - api-gateway
    networks:
      - ride-hailing-network
    restart: unless-stopped

# =========================================
# Volumes (Persistent Data)
# =========================================
volumes:
  matching-db-data:
  pricing-db-data:
  payment-db-data:

# =========================================
# Networks
# =========================================
networks:
  ride-hailing-network:
    driver: bridge
    name: ride-hailing-network
